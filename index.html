<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATA Sulteng - Media Aspirasi dan Aduan Tambang Sulawesi Tengah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-green-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2">MATA SULTENG</h1>
                <p class="text-xl opacity-90">Media Aspirasi dan Aduan Tambang Sulawesi Tengah</p>
                <p class="text-sm mt-2 opacity-80">Suara Anda untuk Lingkungan yang Lebih Baik</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Form Aduan -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Sampaikan Aduan Anda
            </h2>
            
            <form id="aduanForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pelapor *</label>
                        <input type="text" id="namaPelapor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Masukkan nama lengkap">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. HP *</label>
                        <input type="tel" id="noHp" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="08xxxxxxxxxx">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Kejadian *</label>
                        <input type="text" id="lokasi" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Kabupaten/Kota, Kecamatan, Desa">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Perusahaan</label>
                        <input type="text" id="namaPerusahaan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Nama perusahaan tambang (jika diketahui)">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Aduan *</label>
                    <select id="jenisAduan" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="">Pilih jenis aduan</option>
                        <option value="Pencemaran Air">Pencemaran Air</option>
                        <option value="Pencemaran Udara">Pencemaran Udara</option>
                        <option value="Kerusakan Lahan">Kerusakan Lahan</option>
                        <option value="Kebisingan">Kebisingan</option>
                        <option value="Pelanggaran Izin">Pelanggaran Izin</option>
                        <option value="Dampak Sosial">Dampak Sosial</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Aduan *</label>
                    <textarea id="deskripsiAduan" required rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Jelaskan secara detail kejadian yang ingin Anda laporkan..."></textarea>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitText">Kirim Aduan</span>
                    <span id="submitLoading" class="hidden">
                        <span class="loading mr-2"></span>
                        Mengirim...
                    </span>
                </button>
            </form>

            <!-- Alert Messages -->
            <div id="alertSuccess" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                <strong>Berhasil!</strong> Aduan Anda telah dikirim dan tersimpan di database.
            </div>
            <div id="alertError" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                <strong>Error!</strong> <span id="errorMessage">Terjadi kesalahan saat mengirim aduan.</span>
            </div>
        </div>

        <!-- Daftar Aduan Terkini -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Aduan Terkini
                </h2>
                <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="loadingAduan" class="text-center py-8">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-gray-600">Memuat data aduan...</p>
            </div>

            <div id="daftarAduan" class="space-y-6 hidden">
                <!-- Aduan akan dimuat di sini -->
            </div>

            <div id="noData" class="hidden text-center py-8 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>Belum ada aduan yang tersimpan</p>
            </div>

            <div class="flex justify-center mt-8">
                <button id="nextBtn" class="hidden bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Lihat Aduan Lainnya
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 MATA Sulteng. Bersama menjaga lingkungan Sulawesi Tengah.</p>
        </div>
    </footer>

    <script>
        // URL Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyG2S5tsFsfFA7NzitDFhbS1SlkpndZbaMNP6mtNpLiLMwNZSnyyUGViw1WBy08KJ96yQ/exec';
        
        let allAduans = [];
        let currentPage = 0;
        const itemsPerPage = 5;

        // Fungsi untuk mengirim data ke Google Sheets
        async function kirimKeSpreadsheet(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Karena mode no-cors, kita tidak bisa membaca response
                // Tapi jika tidak ada error, berarti berhasil
                return { success: true };
            } catch (error) {
                console.error('Error mengirim data:', error);
                return { success: false, error: error.message };
            }
        }

        // Fungsi untuk mengambil data dari Google Sheets
        async function ambilDariSpreadsheet() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=get');
                
                if (!response.ok) {
                    throw new Error('Gagal mengambil data');
                }
                
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error mengambil data:', error);
                return [];
            }
        }

        // Fungsi untuk menampilkan status
        function getStatusColor(status) {
            switch(status) {
                case 'Dalam Proses': return 'bg-yellow-100 text-yellow-800';
                case 'Ditindaklanjuti': return 'bg-blue-100 text-blue-800';
                case 'Selesai': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Fungsi untuk format tanggal
        function formatTanggal(dateString) {
            if (!dateString) return 'Tidak diketahui';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        // Fungsi untuk menampilkan aduan
        function displayAduans() {
            const container = document.getElementById('daftarAduan');
            const loadingElement = document.getElementById('loadingAduan');
            const noDataElement = document.getElementById('noData');
            
            if (allAduans.length === 0) {
                loadingElement.classList.add('hidden');
                container.classList.add('hidden');
                noDataElement.classList.remove('hidden');
                return;
            }

            loadingElement.classList.add('hidden');
            noDataElement.classList.add('hidden');
            container.classList.remove('hidden');

            const startIndex = currentPage * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const aduansToShow = allAduans.slice(startIndex, endIndex);

            if (currentPage === 0) {
                container.innerHTML = '';
            }

            aduansToShow.forEach((aduan, index) => {
                const aduanElement = document.createElement('div');
                aduanElement.className = 'border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
                aduanElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-800">${aduan['Jenis Aduan'] || 'Tidak diketahui'}</h3>
                            <p class="text-sm text-gray-600">${aduan.Lokasi || 'Lokasi tidak diketahui'} • ${formatTanggal(aduan.Tanggal)}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(aduan.Status)}">
                            ${aduan.Status || 'Dalam Proses'}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 mb-2"><strong>Pelapor:</strong> ${aduan['Nama Pelapor'] || 'Anonim'}</p>
                        <p class="text-gray-700 mb-2"><strong>No. HP:</strong> ${aduan['No HP'] || 'Tidak tersedia'}</p>
                        ${aduan['Nama Perusahaan'] ? `<p class="text-gray-700 mb-2"><strong>Perusahaan:</strong> ${aduan['Nama Perusahaan']}</p>` : ''}
                        <p class="text-gray-700"><strong>Deskripsi:</strong> ${aduan['Deskripsi Aduan'] || 'Tidak ada deskripsi'}</p>
                    </div>
                    
                    ${aduan.Balasan ? `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-4">
                            <p class="text-sm font-medium text-blue-800 mb-1">Balasan:</p>
                            <p class="text-sm text-blue-700">${aduan.Balasan}</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(aduanElement);
            });

            // Update tombol next
            const nextBtn = document.getElementById('nextBtn');
            if (endIndex >= allAduans.length) {
                nextBtn.classList.add('hidden');
            } else {
                nextBtn.classList.remove('hidden');
            }
        }

        // Fungsi untuk memuat data aduan
        async function loadAduans() {
            document.getElementById('loadingAduan').classList.remove('hidden');
            document.getElementById('daftarAduan').classList.add('hidden');
            document.getElementById('noData').classList.add('hidden');
            
            allAduans = await ambilDariSpreadsheet();
            
            // Urutkan berdasarkan tanggal terbaru
            allAduans.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));
            
            currentPage = 0;
            displayAduans();
        }

        // Fungsi untuk menampilkan alert
        function showAlert(type, message) {
            const successAlert = document.getElementById('alertSuccess');
            const errorAlert = document.getElementById('alertError');
            
            if (type === 'success') {
                successAlert.classList.remove('hidden');
                errorAlert.classList.add('hidden');
            } else {
                document.getElementById('errorMessage').textContent = message;
                errorAlert.classList.remove('hidden');
                successAlert.classList.add('hidden');
            }
            
            // Sembunyikan alert setelah 5 detik
            setTimeout(() => {
                successAlert.classList.add('hidden');
                errorAlert.classList.add('hidden');
            }, 5000);
        }

        // Event listener untuk form submit
        document.getElementById('aduanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            // Disable button dan tampilkan loading
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
            
            // Ambil data form
            const formData = {
                nama: document.getElementById('namaPelapor').value.trim(),
                noHp: document.getElementById('noHp').value.trim(),
                lokasi: document.getElementById('lokasi').value.trim(),
                perusahaan: document.getElementById('namaPerusahaan').value.trim(),
                jenis: document.getElementById('jenisAduan').value,
                deskripsi: document.getElementById('deskripsiAduan').value.trim()
            };

            // Validasi nomor HP
            if (!/^08\d{8,11}$/.test(formData.noHp)) {
                showAlert('error', 'Format nomor HP tidak valid. Gunakan format 08xxxxxxxxxx');
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
                return;
            }

            try {
                const result = await kirimKeSpreadsheet(formData);
                
                if (result.success) {
                    showAlert('success', 'Aduan berhasil dikirim!');
                    this.reset(); // Reset form
                    
                    // Reload data aduan setelah 2 detik
                    setTimeout(() => {
                        loadAduans();
                    }, 2000);
                } else {
                    showAlert('error', result.error || 'Gagal mengirim aduan. Silakan coba lagi.');
                }
            } catch (error) {
                showAlert('error', 'Terjadi kesalahan. Silakan coba lagi.');
            }
            
            // Enable button kembali
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
        });

        // Event listener untuk tombol next
        document.getElementById('nextBtn').addEventListener('click', function() {
            currentPage++;
            displayAduans();
        });

        // Event listener untuk tombol refresh
        document.getElementById('refreshBtn').addEventListener('click', function() {
            loadAduans();
        });

        // Load data saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            loadAduans();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9715e20f43ed4083',t:'MTc1NTU2Njk5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
